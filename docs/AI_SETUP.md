# AI 할 일 생성 기능 설정 가이드

## 개요

자연어로 입력된 할 일을 Google Gemini AI를 통해 구조화된 데이터로 자동 변환하는 기능입니다.

## 필요한 API 키

### Google Gemini API Key

1. [Google AI Studio](https://makersuite.google.com/app/apikey) 접속
2. API Key 생성
3. `.env.local` 파일에 추가:

```bash
GOOGLE_GENERATIVE_AI_API_KEY=your_gemini_api_key
```

## 환경 변수 설정

프로젝트 루트에 `.env.local` 파일을 생성하고 다음 내용을 추가하세요:

```bash
# Supabase
NEXT_PUBLIC_SUPABASE_URL=your_project_url
NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY=your_publishable_key

# Google Generative AI (Gemini)
GOOGLE_GENERATIVE_AI_API_KEY=your_gemini_api_key
```

## 사용 방법

### 1. 할 일 추가 화면에서 "AI로 생성" 버튼 클릭

새로운 할 일을 추가할 때 "AI로 생성" 버튼을 클릭하면 AI 생성 다이얼로그가 열립니다.

### 2. 자연어로 할 일 입력

다음과 같이 자연스럽게 할 일을 입력하세요:

**입력 예시:**
- "내일 오후 3시까지 중요한 팀 회의 준비하기"
- "다음주 월요일까지 프로젝트 보고서 작성"
- "오늘 저녁까지 이메일 답장하기"
- "이번 주 금요일 오전 9시 디자인 리뷰 미팅"
- "모레 아침에 병원 가기"
- "언젠가 천천히 요가 강의 듣기"

### 3. AI가 자동으로 데이터 구조화

AI가 입력된 내용을 분석하여 다음 정보를 자동으로 추출합니다:

#### 📋 제목
- 핵심 내용만 간결하게 (동사형 선호)

#### 📝 설명
- 추가 세부사항 (있는 경우)

#### 📅 마감일 (날짜 처리 규칙)
- **오늘** → 현재 날짜
- **내일** → 현재 날짜 + 1일
- **모레** → 현재 날짜 + 2일
- **이번 주 금요일** → 가장 가까운 금요일
- **다음 주 월요일** → 다음 주의 월요일

#### ⏰ 마감시간 (시간 처리 규칙)
- **아침** → 09:00
- **점심** → 12:00
- **오후** → 14:00
- **저녁** → 18:00
- **밤** → 21:00
- 구체적 시간 명시 시 그대로 변환 (예: "오후 3시" → 15:00)
- 시간 언급 없으면 09:00 기본값

#### ⭐ 우선순위 (키워드 기반)
- **높음(high)**: "급하게", "중요한", "빨리", "꼭", "반드시"
- **보통(medium)**: "보통", "적당히", 키워드 없음
- **낮음(low)**: "여유롭게", "천천히", "언젠가"

#### 🏷️ 카테고리 (키워드 기반, 여러 개 가능)
- **업무**: "회의", "보고서", "프로젝트", "업무", "미팅", "발표"
- **개인**: "쇼핑", "친구", "가족", "개인", "약속", "생일"
- **건강**: "운동", "병원", "건강", "요가", "헬스", "진료"
- **학습**: "공부", "책", "강의", "학습", "수업", "시험"

### 4. 생성된 데이터 확인 및 수정

AI가 생성한 데이터가 폼 필드에 자동으로 채워집니다. 필요시 직접 수정할 수 있습니다.

## 출력 예시

### 예시 1: 업무 일정

**입력:**
```
내일 오후 3시까지 중요한 팀 회의 준비하기
```

**AI 생성 결과:**
```json
{
  "title": "팀 회의 준비",
  "due_date": "2026-01-15",
  "due_time": "15:00",
  "priority": "high",
  "category": ["업무"]
}
```

### 예시 2: 건강 관리

**입력:**
```
모레 아침에 병원 진료 받기
```

**AI 생성 결과:**
```json
{
  "title": "병원 진료",
  "due_date": "2026-01-16",
  "due_time": "09:00",
  "priority": "medium",
  "category": ["건강"]
}
```

### 예시 3: 우선순위 낮은 할 일

**입력:**
```
언젠가 천천히 요가 강의 듣기
```

**AI 생성 결과:**
```json
{
  "title": "요가 강의 수강",
  "priority": "low",
  "category": ["건강", "학습"]
}
```

### 예시 4: 이번 주 일정

**입력:**
```
이번 주 금요일 저녁에 친구 생일 파티
```

**AI 생성 결과:**
```json
{
  "title": "친구 생일 파티",
  "due_date": "2026-01-17",
  "due_time": "18:00",
  "priority": "medium",
  "category": ["개인"]
}
```

## 기술 스택

- **AI Model**: Google Gemini 2.0 Flash (Experimental)
- **AI SDK**: Vercel AI SDK (`ai` package)
- **Provider**: `@ai-sdk/google`
- **API Route**: Next.js App Router (`/api/ai/generate-todo`)
- **Validation**: Zod Schema

## API 엔드포인트

### POST /api/ai/generate-todo

자연어 입력을 구조화된 할 일 데이터로 변환합니다.

**Request Body:**
```json
{
  "prompt": "내일 오후 3시까지 중요한 팀 회의 준비하기"
}
```

**Response (Success):**
```json
{
  "success": true,
  "data": {
    "title": "팀 회의 준비",
    "description": "",
    "due_date": "2026-01-15",
    "due_time": "15:00",
    "priority": "high",
    "category": ["업무"]
  }
}
```

**Response (Error):**
```json
{
  "success": false,
  "error": "에러 메시지"
}
```

## 에러 처리

### HTTP 상태 코드

API는 다음과 같은 HTTP 상태 코드를 반환합니다:

#### ✅ 200 OK
- 성공적으로 할 일이 생성됨

#### ❌ 400 Bad Request (잘못된 입력)
**발생 상황:**
- 빈 문자열 또는 null 입력
- 2자 미만의 짧은 입력
- 500자 초과의 긴 입력
- 유효한 문자(한글/영문/숫자)가 없는 입력
- JSON 형식 오류

**에러 메시지:**
- "유효한 할 일 내용을 입력해주세요."
- "할 일 내용이 너무 짧습니다. 최소 2자 이상 입력해주세요."
- "할 일 내용이 너무 깁니다. 최대 500자까지 입력 가능합니다."
- "할 일 내용에 유효한 문자가 포함되어야 합니다."
- "요청 데이터 형식이 올바르지 않습니다."

**해결 방법:** 입력 내용을 확인하고 유효한 텍스트로 수정

#### ❌ 401 Unauthorized (인증 실패)
**발생 상황:**
- API 키가 설정되지 않음
- API 키가 유효하지 않음
- API 키 권한 문제

**에러 메시지:**
- "AI 서비스 인증에 실패했습니다. 관리자에게 문의해주세요."

**해결 방법:** 
1. `.env.local`에 `GOOGLE_GENERATIVE_AI_API_KEY` 확인
2. [Google AI Studio](https://makersuite.google.com/app/apikey)에서 API 키 재발급
3. 개발 서버 재시작

#### ❌ 429 Too Many Requests (호출 한도 초과)
**발생 상황:**
- API 호출 빈도가 너무 높음
- 일일 할당량 초과
- Rate limit 도달

**에러 메시지:**
- "AI 서비스 사용량을 초과했습니다. 잠시 후 다시 시도해주세요."

**해결 방법:**
1. 몇 분 후 다시 시도
2. Google AI Studio에서 할당량 확인
3. 필요시 유료 플랜으로 업그레이드

#### ❌ 500 Internal Server Error (AI 처리 실패)
**발생 상황:**
- AI 모델 처리 중 오류
- 서버 내부 오류
- 예상치 못한 에러

**에러 메시지:**
- "AI 서비스 설정이 완료되지 않았습니다." (API 키 미설정)
- "AI 처리 중 오류가 발생했습니다. 다시 시도해주세요."
- "할 일 생성 중 오류가 발생했습니다. 잠시 후 다시 시도해주세요."

**해결 방법:**
1. 잠시 후 다시 시도
2. 브라우저 콘솔에서 상세 에러 확인
3. 서버 로그 확인

#### ❌ 503 Service Unavailable (네트워크 오류)
**발생 상황:**
- 네트워크 연결 실패
- AI 서비스 접근 불가

**에러 메시지:**
- "네트워크 연결에 실패했습니다. 인터넷 연결을 확인해주세요."

**해결 방법:**
1. 인터넷 연결 확인
2. 방화벽 설정 확인
3. VPN 사용 시 비활성화 후 재시도

#### ❌ 504 Gateway Timeout (타임아웃)
**발생 상황:**
- AI 처리 시간 초과
- 네트워크 지연

**에러 메시지:**
- "요청 시간이 초과되었습니다. 다시 시도해주세요."

**해결 방법:**
1. 입력 내용을 더 간결하게 수정
2. 잠시 후 다시 시도

### 에러 응답 형식

모든 에러는 다음 형식으로 반환됩니다:

```json
{
  "success": false,
  "error": "사용자 친화적인 에러 메시지"
}
```

### 개발자용 로그

서버 콘솔에는 상세한 디버깅 정보가 출력됩니다:

```
[AI API] 입력 처리: { original: "...", processed: "...", ... }
[AI API] 생성 완료: { title: "...", priority: "...", ... }
[AI API] 할 일 생성 실패: Error: ...
```

## 제한사항

- **입력 길이**: 최소 2자, 최대 500자
- **API 할당량**: Google Gemini API 무료 티어 제한 적용
- **지원 언어**: 현재 한국어에 최적화됨
- **지원 카테고리**: 업무, 개인, 건강, 학습 (4개 고정)

## 데이터 처리 파이프라인

### 1️⃣ 입력 검증 (Validation)

API는 다음과 같은 검증을 수행합니다:

- ✅ **빈 문자열 체크**: 빈 입력 차단
- ✅ **최소 길이 검증**: 2자 이상 필수
- ✅ **최대 길이 검증**: 500자 이하 필수
- ✅ **유효한 문자 포함**: 한글, 영문, 숫자 중 하나 이상 포함 필요
- ❌ 특수문자나 이모지만 있는 입력 차단

**검증 실패 시 400 에러**와 함께 사용자 친화적 메시지 반환

### 2️⃣ 전처리 (Preprocessing)

입력 텍스트를 AI에 전달하기 전 자동으로 정제합니다:

- 🔹 **공백 제거**: 앞뒤 불필요한 공백 제거
- 🔹 **공백 통합**: 연속된 공백을 하나로 통합
- 🔹 **줄바꿈 정리**: 연속된 줄바꿈을 하나로 통합
- 🔹 **정규화**: 일관된 형식으로 변환

**예시:**
```
입력: "  내일    오후   3시까지   회의  준비  "
전처리 후: "내일 오후 3시까지 회의 준비"
```

### 3️⃣ 후처리 (Postprocessing)

AI가 생성한 데이터를 검증하고 보정합니다:

#### 제목 처리
- 100자 초과 시 자동 축약 (97자 + "...")
- 1자 이하 시 "할 일"로 기본값 설정
- 앞뒤 공백 제거

#### 날짜 처리
- **과거 날짜 자동 수정**: 과거 날짜는 오늘로 변경
- 날짜 형식 검증 (YYYY-MM-DD)

#### 시간 처리
- **시간 형식 검증**: HH:mm (24시간제)
- 잘못된 형식은 09:00으로 기본값 설정

#### 필수 필드 보정
- **우선순위 누락 시**: medium (보통) 설정
- **카테고리 누락 시**: ["개인"] 설정
- **제목 누락 시**: "할 일" 설정

**예시:**
```json
// AI 생성 (원본)
{
  "title": "이것은 매우 긴 제목인데 100자를 넘어가는 경우 자동으로 잘려서 표시됩니다...",
  "due_date": "2026-01-10",  // 과거 날짜
  "due_time": "25:00",        // 잘못된 형식
  "priority": "invalid"       // 잘못된 값
}

// 후처리 결과
{
  "title": "이것은 매우 긴 제목인데 100자를 넘어가는 경우 자동으로 잘려서 표시됩니다...",
  "due_date": "2026-01-15",  // 오늘로 변경
  "due_time": "09:00",       // 기본값
  "priority": "medium"       // 기본값
}
```

## 문제 해결

### AI 생성이 작동하지 않을 때

1. `.env.local` 파일에 `GOOGLE_GENERATIVE_AI_API_KEY`가 설정되어 있는지 확인
2. 개발 서버를 재시작 (`npm run dev`)
3. 브라우저 콘솔에서 에러 메시지 확인
4. API 키가 유효한지 [Google AI Studio](https://makersuite.google.com/app/apikey)에서 확인

### 날짜/시간 인식이 정확하지 않을 때

AI는 다음 규칙에 따라 날짜/시간을 인식합니다:

**날짜 규칙:**
- "오늘", "내일", "모레" - 정확히 인식
- "이번 주 금요일" - 가장 가까운 금요일
- "다음 주 월요일" - 다음 주의 월요일

**시간 규칙:**
- "아침"(09:00), "점심"(12:00), "오후"(14:00), "저녁"(18:00), "밤"(21:00)
- "오후 3시", "15시" - 구체적 시간은 정확히 변환

💡 **팁**: 더 정확한 인식을 원하면 구체적으로 입력하거나, 생성 후 폼에서 직접 수정 가능

## 테스트 케이스

### ✅ 정상 입력

| 입력 | 전처리 후 | 결과 |
|------|-----------|------|
| "내일 오후 3시 회의" | "내일 오후 3시 회의" | ✅ 성공 |
| "  공백   많은   입력  " | "공백 많은 입력" | ✅ 성공 (공백 통합) |
| "모레 아침 병원 가기" | "모레 아침 병원 가기" | ✅ 성공 |

### ❌ 잘못된 입력

| 입력 | 에러 | 상태 코드 |
|------|------|-----------|
| "" (빈 문자열) | "유효한 할 일 내용을 입력해주세요." | 400 |
| "a" (1자) | "할 일 내용이 너무 짧습니다." | 400 |
| (500자 초과) | "할 일 내용이 너무 깁니다." | 400 |
| "!!@@##" (특수문자만) | "할 일 내용에 유효한 문자가 포함되어야 합니다." | 400 |

### 🔧 후처리 적용 사례

| AI 생성 원본 | 후처리 결과 | 변경 사항 |
|-------------|------------|----------|
| title: "a" | title: "할 일" | 너무 짧은 제목 → 기본값 |
| due_date: "2026-01-10" (과거) | due_date: "2026-01-15" (오늘) | 과거 날짜 → 오늘로 변경 |
| due_time: "25:00" | due_time: "09:00" | 잘못된 시간 → 기본값 |
| priority: undefined | priority: "medium" | 누락 → 기본값 |
| category: [] | category: ["개인"] | 누락 → 기본값 |

## 향후 개선 계획

- [ ] 다국어 지원 (영어, 일본어 등)
- [ ] 반복 일정 자동 생성
- [ ] 하위 작업(subtask) 자동 생성
- [ ] 관련 링크/파일 자동 추출
- [ ] 사용자 피드백 학습
- [ ] 입력 히스토리 기반 개인화
- [ ] 더 정교한 날짜/시간 파싱

## 참고 자료

- [Google AI Studio](https://makersuite.google.com/)
- [Vercel AI SDK Documentation](https://sdk.vercel.ai/docs)
- [Gemini API Documentation](https://ai.google.dev/docs)
